# ============================================================================
# FICHIER : .github/workflows/deploy-render.yml
# ============================================================================
#
# QU'EST-CE QUE CE WORKFLOW ?
# ===========================
# Ce workflow d√©ploie automatiquement l'API sur Render.com apr√®s les tests.
# Render.com est une plateforme d'h√©bergement cloud (comme Heroku).
#
# QU'EST-CE QUE LE D√âPLOIEMENT CONTINU (CD) ?
# ============================================
# CD = Continuous Deployment (D√©ploiement Continu)
# Apr√®s chaque modification valid√©e, l'application est automatiquement
# d√©ploy√©e en production (ou en environnement de test).
#
# COMMENT √áA MARCHE AVEC RENDER ?
# ================================
# Render.com fournit un "webhook" (URL sp√©ciale).
# Quand on envoie une requ√™te POST √† cette URL, Render red√©ploie l'application.
# Ce workflow envoie cette requ√™te automatiquement.
#
# ENVIRONNEMENTS :
# =================
# - Branche "dev" ‚Üí Environnement de d√©veloppement (test)
# - Branche "main" ‚Üí Environnement de production
#
# ============================================================================

# Nom du workflow
name: Deploy to Render

# ============================================================================
# SECTION : on (d√©clencheurs)
# ============================================================================
on:
  # push : d√©clenchement √† chaque push
  push:
    # branches : seulement sur "dev" et "main"
    branches: [ "dev", "main" ]
  
  # workflow_run : d√©clenchement apr√®s qu'un autre workflow se termine
  workflow_run:
    # workflows : nom du workflow √† attendre
    workflows: ["CI - Tests et Validation"]
    # types : type d'√©v√©nement (completed = termin√©)
    types:
      - completed

# ============================================================================
# SECTION : jobs
# ============================================================================
jobs:
  # Job de d√©ploiement
  deploy:
    # Machine virtuelle Ubuntu
    runs-on: ubuntu-latest
    
    # Condition : ne d√©ployer que si les tests passent
    # github.event.workflow_run.conclusion == 'success' : le workflow CI a r√©ussi
    # || github.event_name == 'push' : OU si c'est un push direct (pas de workflow_run)
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'push'
    
    # √âtapes de d√©ploiement
    steps:
      # √âTAPE 1 : R√©cup√©rer le code
      - name: Checkout code
        uses: actions/checkout@v4

      # √âTAPE 2 : D√©clencher le d√©ploiement Render
      - name: Trigger Render Deploy
        env:
          # HOOK_DEV : URL du webhook Render pour l'environnement de d√©veloppement
          # ${{ secrets.RENDER_HOOK_DEV }} : variable secr√®te GitHub
          # Les secrets sont configur√©s dans Settings > Secrets du d√©p√¥t GitHub
          HOOK_DEV: ${{ secrets.RENDER_HOOK_DEV }}
          
          # HOOK_PROD : URL du webhook Render pour la production
          HOOK_PROD: ${{ secrets.RENDER_HOOK_PROD }}
          
          # BRANCH : nom de la branche actuelle
          # github.ref_name : nom de la branche (ex: "main", "dev")
          BRANCH: ${{ github.ref_name }}
        run: |
          # V√©rifier sur quelle branche on est
          if [ "$BRANCH" = "main" ]; then
            # Branche main = production
            echo "üöÄ D√©ploiement en production..."
            # Envoyer une requ√™te POST au webhook de production
            # curl : outil en ligne de commande pour faire des requ√™tes HTTP
            # -X POST : m√©thode HTTP POST
            curl -X POST "$HOOK_PROD"
          else
            # Branche dev = d√©veloppement
            echo "üöÄ D√©ploiement en d√©veloppement..."
            # Envoyer une requ√™te POST au webhook de d√©veloppement
            curl -X POST "$HOOK_DEV"
          fi

      # √âTAPE 3 : Attendre que le d√©ploiement se termine
      - name: Wait for deployment
        run: |
          echo "‚è≥ Attente du d√©ploiement..."
          # Attendre 30 secondes pour laisser le temps √† Render de d√©ployer
          # En production, on pourrait utiliser une boucle qui v√©rifie le statut
          sleep 30

      # √âTAPE 4 : V√©rifier que l'API fonctionne (health check)
      - name: Health check
        run: |
          # D√©terminer l'URL selon la branche
          if [ "$BRANCH" = "main" ]; then
            # URL de production (variable secr√®te GitHub)
            URL="${{ secrets.RENDER_URL_PROD }}"
          else
            # URL de d√©veloppement
            URL="${{ secrets.RENDER_URL_DEV }}"
          fi
          
          # V√©rifier que l'URL est d√©finie
          # -n : v√©rifie que la variable n'est pas vide
          if [ -n "$URL" ]; then
            echo "üîç V√©rification de la sant√© de l'API..."
            # curl -f : √©choue si le code HTTP n'est pas 2xx
            # || echo : si curl √©choue, affiche un message d'avertissement
            # Cela n'arr√™te pas le workflow (pas d'erreur fatale)
            curl -f "$URL/health" || echo "‚ö†Ô∏è Health check failed"
          fi
