name: Deploy to Render

on:
  push:
    branches: [ "dev", "main" ]
  workflow_run:
    workflows: ["CI - Tests et Validation"]
    types:
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Ne d√©ployer que si les tests passent
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Trigger Render Deploy
        env:
          HOOK_DEV: ${{ secrets.RENDER_HOOK_DEV }}
          HOOK_PROD: ${{ secrets.RENDER_HOOK_PROD }}
          BRANCH: ${{ github.ref_name }}
        run: |
          if [ "$BRANCH" = "main" ]; then
            echo "üöÄ D√©ploiement en production..."
            curl -X POST "$HOOK_PROD"
          else
            echo "üöÄ D√©ploiement en d√©veloppement..."
            curl -X POST "$HOOK_DEV"
          fi

      - name: Wait for deployment
        run: |
          echo "‚è≥ Attente du d√©ploiement..."
          sleep 30

      - name: Health check
        run: |
          if [ "$BRANCH" = "main" ]; then
            URL="${{ secrets.RENDER_URL_PROD }}"
          else
            URL="${{ secrets.RENDER_URL_DEV }}"
          fi
          
          if [ -n "$URL" ]; then
            echo "üîç V√©rification de la sant√© de l'API..."
            curl -f "$URL/health" || echo "‚ö†Ô∏è Health check failed"
          fi
