# ============================================================================
# FICHIER : .github/workflows/train_model.yml
# ============================================================================
#
# QU'EST-CE QUE CE WORKFLOW ?
# ===========================
# Ce workflow entraîne automatiquement le modèle de machine learning.
# Il peut être déclenché manuellement ou automatiquement (hebdomadaire).
#
# POURQUOI ENTRÂINER LE MODÈLE AUTOMATIQUEMENT ?
# ===============================================
# 1. Réentraînement régulier avec de nouvelles données
# 2. Détection automatique de dérive des données (data drift)
# 3. Mise à jour automatique du modèle en production
#
# COMMENT ÇA MARCHE ?
# ===================
# 1. Le workflow démarre (manuellement ou automatiquement)
# 2. Il lance un serveur PostgreSQL temporaire
# 3. Il charge les données depuis PostgreSQL
# 4. Il entraîne le modèle avec Optuna (optimisation d'hyperparamètres)
# 5. Il sauvegarde le modèle dans les "artifacts" GitHub
# 6. (Optionnel) Il commit le modèle dans le dépôt Git
#
# ============================================================================

# Nom du workflow
name: Train Model

# ============================================================================
# SECTION : on (déclencheurs)
# ============================================================================
on:
  # workflow_dispatch : permet de lancer le workflow manuellement
  # Dans l'interface GitHub Actions, vous verrez un bouton "Run workflow"
  workflow_dispatch:   # Lancement manuel
  
  # schedule : exécution automatique selon un calendrier
  schedule:
    # cron : format de planification (comme cron sur Linux)
    # Format : "minute heure jour mois jour_semaine"
    # '0 2 * * 0' : tous les dimanches à 2h du matin (UTC)
    # - 0 : minute 0
    # - 2 : heure 2 (2h du matin)
    # - * : n'importe quel jour du mois
    # - * : n'importe quel mois
    # - 0 : dimanche (0 = dimanche, 1 = lundi, ..., 6 = samedi)
    - cron: '0 2 * * 0'

# ============================================================================
# SECTION : jobs
# ============================================================================
jobs:
  # Job d'entraînement du modèle
  train:
    # Machine virtuelle Ubuntu
    runs-on: ubuntu-latest
    
    # Service PostgreSQL (même configuration que dans ci.yml)
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: password
          POSTGRES_DB: mydatabase
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    # Étapes d'entraînement
    steps:
      # ÉTAPE 1 : Récupérer le code
      - name: Checkout code
        uses: actions/checkout@v4

      # ÉTAPE 2 : Installer Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # ÉTAPE 3 : Installer les dépendances
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r app/requirements.txt

      # ÉTAPE 4 : Initialiser la base de données
      - name: Initialize database
        env:
          DATABASE_URL: postgresql://postgres:password@localhost:5432/mydatabase
        run: |
          # Attendre 10 secondes (plus long que dans CI car on charge plus de données)
          sleep 10
          # Charger le script SQL avec les données
          if [ -f "db/init/attrition.sql" ]; then
            PGPASSWORD=password psql -h localhost -U postgres -d mydatabase -f db/init/attrition.sql
          fi

      # ÉTAPE 5 : Entraîner le modèle
      - name: Run training
        env:
          # URL de la base de données
          DATABASE_URL: postgresql://postgres:password@localhost:5432/mydatabase
          # OPTUNA_TRIALS : nombre d'essais Optuna (réduit pour CI = plus rapide)
          # En production, on utiliserait 60 ou plus
          OPTUNA_TRIALS: 30  # Réduire pour CI
          # OPTUNA_TIMEOUT : temps maximum en secondes (10 minutes)
          # Si l'entraînement dépasse ce temps, il s'arrête
          OPTUNA_TIMEOUT: 600  # 10 minutes max
        run: |
          # Exécuter le script d'entraînement
          python app/train_model.py

      # ÉTAPE 6 : Uploader les artefacts (modèles entraînés)
      - name: Upload model artifacts
        # actions/upload-artifact@v3 : upload les fichiers vers GitHub
        uses: actions/upload-artifact@v3
        # if: success() : seulement si toutes les étapes précédentes ont réussi
        if: success()
        with:
          # name : nom de l'artefact (visible dans l'interface GitHub)
          name: trained-model
          # path : dossier à uploader (tous les fichiers dans models/)
          path: models/
          # retention-days : nombre de jours avant suppression automatique
          retention-days: 30

      # ÉTAPE 7 : Commit et push du modèle (optionnel)
      - name: Commit and push model (optional)
        # Conditions pour cette étape :
        # - github.ref == 'refs/heads/main' : seulement sur la branche main
        # - success() : seulement si tout a réussi
        if: github.ref == 'refs/heads/main' && success()
        run: |
          # Configurer Git avec l'identité de GitHub Actions
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Ajouter les fichiers du modèle au staging
          git add models/
          
          # Commit seulement s'il y a des changements
          # git diff --staged --quiet : vérifie s'il y a des changements
          # || : si la commande précédente échoue (il y a des changements), exécute la suivante
          # [skip ci] : évite de déclencher d'autres workflows CI
          git diff --staged --quiet || git commit -m "Auto-update: Retrain model [skip ci]"
          
          # Push vers GitHub
          # || echo : si le push échoue (ex: pas de changements), affiche un message
          git push || echo "No changes to commit"
